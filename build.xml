<?xml version="1.0"?>
<project name="SabreDAV" default="build" basedir=".">

    <target name="build" depends="init,test">
        <exec command="bin/pearpackage.php make pearfarm" checkreturn="true" />
        <exec command="pear package" passthru="1" />
        <move file="Sabre_DAV-${sabredav.version}.tgz" tofile="Sabre_DAV-${sabredav.version}_PEARFARM.tgz" />
        <exec command="bin/pearpackage.php make" checkreturn="true" />
        <exec command="pear package" passthru="1" />
    </target>

    <target name="clean" depends="init">
        <echo msg="Removing build files (cleaning up distribution)" />
        <delete dir="apidocs" />
        <delete file="package.xml" />
        <delete file="Sabre_DAV-${sabredav.version}.tgz" />
        <delete file="Sabre_DAV-${sabredav.version}_PEARFARM.tgz" />
    </target>    

    <target name="release" depends="init,test,build">
        <echo>Creating Mercurial release tag</echo>
        <exec command="hg tag version-${sabredav.version}" checkreturn="true" passthru="1" />
        <echo>Pushing to pearfarm</echo>
        <exec command="pearfarm push Sabre_DAV-${sabredav.version}_PEARFARM.tgz" checkreturn="true" passthru="1" />
        <echo>Uploading to Google Code</echo>
        <propertyprompt propertyName="googlecode.username" defaultValue="evertpot" promptText="Enter your googlecode username" />
        <propertyprompt propertyName="googlecode.password" promptText="Enter your googlecode password" />
        <exec command="bin/googlecode_upload.py -s 'SabreDAV ${sabredav.version}' -p sabredav --labels=${sabredav.ucstability} -u '${googlecode.username}' -w '${googlecode.password}' Sabre_DAV-${sabredav.version}.tgz" checkreturn="true" passthru="1" />
    </target>

    <target name="test">
        <phpunit haltonfailure="1" haltonerror="1" bootstrap="tests/bootstrap.php" haltonskipped="1" printsummary="1">
          <batchtest>
            <fileset dir="tests">
              <include name="**/*.php"/>
            </fileset>
          </batchtest>
        </phpunit>
    </target>

    <target name="init">

        <!-- This sets SabreDAV version information -->
        <adhoc-task name="sabredav-version"><![CDATA[

            class SabreDAV_VersionTask extends Task {

                public function main() {

                    include 'lib/Sabre/DAV/Version.php';
                    $this->getProject()->setNewProperty('sabredav.version',Sabre_DAV_Version::VERSION);
                    $this->getProject()->setNewProperty('sabredav.stability',Sabre_DAV_Version::STABILITY);
                    $this->getProject()->setNewProperty('sabredav.ucstability',ucwords(Sabre_DAV_Version::STABILITY));

                }

            }

        ]]></adhoc-task>
        <sabredav-version />
        <echo>SabreDAV version ${sabredav.version}-${sabredav.stability}</echo>

    </target>

</project>
